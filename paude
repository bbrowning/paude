#!/bin/bash
set -e

IMAGE_NAME="paude:latest"
PROXY_IMAGE="paude-proxy:latest"
INTERNAL_NETWORK="paude-internal"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Parse paude-specific flags before passing to claude
ALLOW_NETWORK=false
CLAUDE_ARGS=()
for arg in "$@"; do
    case "$arg" in
        --allow-network)
            ALLOW_NETWORK=true
            ;;
        *)
            CLAUDE_ARGS+=("$arg")
            ;;
    esac
done

resolve_path() {
    local path="$1"
    if [[ -e "$path" ]]; then
        cd -P "$(dirname "$path")" 2>/dev/null && echo "$(pwd -P)/$(basename "$path")"
    fi
}

show_macos_volume_help() {
    local volume_path
    volume_path=$(echo "$WORKSPACE_DIR" | cut -d'/' -f1-3)

    echo "" >&2
    echo "Podman on macOS only mounts /Users by default." >&2
    echo "To use paths under $volume_path, recreate your Podman machine with:" >&2
    echo "" >&2
    echo "  podman machine stop" >&2
    echo "  podman machine rm" >&2
    echo "  podman machine init \\" >&2
    echo "    --volume /Users:/Users \\" >&2
    echo "    --volume /private:/private \\" >&2
    echo "    --volume /var/folders:/var/folders \\" >&2
    echo "    --volume $volume_path:$volume_path" >&2
    echo "  podman machine start" >&2
    echo "" >&2
    echo "Note: This will remove your existing Podman machine. Container images" >&2
    echo "will need to be rebuilt/pulled after recreating the machine." >&2
}

check_requirements() {
    if ! command -v podman &> /dev/null; then
        echo "Error: podman is not installed or not in PATH" >&2
        echo "Please install podman: https://podman.io/getting-started/installation" >&2
        exit 1
    fi
}

build_images() {
    if ! podman image exists "$IMAGE_NAME" 2>/dev/null; then
        echo "Building $IMAGE_NAME image..."
        podman build -t "$IMAGE_NAME" "$SCRIPT_DIR"
    fi

    if [[ "$ALLOW_NETWORK" == "false" ]]; then
        if ! podman image exists "$PROXY_IMAGE" 2>/dev/null; then
            echo "Building $PROXY_IMAGE image..."
            podman build -t "$PROXY_IMAGE" "$SCRIPT_DIR/proxy"
        fi
    fi
}

setup_environment() {
    ENV_ARGS=()
    for var in CLAUDE_CODE_USE_VERTEX ANTHROPIC_VERTEX_PROJECT_ID GOOGLE_CLOUD_PROJECT; do
        if [[ -n "${!var}" ]]; then
            ENV_ARGS+=(-e "$var=${!var}")
        fi
    done

    for var in $(compgen -v | grep '^CLOUDSDK_AUTH'); do
        ENV_ARGS+=(-e "$var=${!var}")
    done
}

setup_mounts() {
    WORKSPACE_DIR="$(pwd -P)"

    MOUNT_ARGS=(
        -v "$WORKSPACE_DIR:$WORKSPACE_DIR:rw"
    )

    GCLOUD_DIR="$(resolve_path "$HOME/.config/gcloud")"
    if [[ -n "$GCLOUD_DIR" && -d "$GCLOUD_DIR" ]]; then
        MOUNT_ARGS+=(-v "$GCLOUD_DIR:/home/paude/.config/gcloud:ro")
    fi

    if [[ ! -d "$HOME/.claude" ]]; then
        mkdir -p "$HOME/.claude"
    fi
    CLAUDE_DIR="$(resolve_path "$HOME/.claude")"
    if [[ -n "$CLAUDE_DIR" && -d "$CLAUDE_DIR" ]]; then
        MOUNT_ARGS+=(-v "$CLAUDE_DIR:/home/paude/.claude:rw")
        MOUNT_ARGS+=(-v "$CLAUDE_DIR:$CLAUDE_DIR:rw")
    fi

    GITCONFIG="$(resolve_path "$HOME/.gitconfig")"
    if [[ -n "$GITCONFIG" && -f "$GITCONFIG" ]]; then
        MOUNT_ARGS+=(-v "$GITCONFIG:/home/paude/.gitconfig:ro")
    fi

    if [[ ! -f "$HOME/.claude.json" ]]; then
        echo '{}' > "$HOME/.claude.json"
    fi
    CLAUDE_JSON="$(resolve_path "$HOME/.claude.json")"
    if [[ -n "$CLAUDE_JSON" && -f "$CLAUDE_JSON" ]]; then
        MOUNT_ARGS+=(-v "$CLAUDE_JSON:/home/paude/.claude.json:rw")
    fi
}

check_macos_volumes() {
    if [[ "$(uname)" == "Darwin" && ! "$WORKSPACE_DIR" =~ ^/Users/ ]]; then
        test_output=$(podman run --rm \
            -v "$WORKSPACE_DIR:$WORKSPACE_DIR:rw" \
            "$IMAGE_NAME" \
            --version 2>&1) || {
            echo "$test_output" >&2
            show_macos_volume_help
            exit 1
        }
    fi
}

check_git_safety() {
    if [[ ! -d "$WORKSPACE_DIR/.git" ]]; then
        echo "Warning: No git repository in workspace." >&2
        echo "  Without git, deleted/modified files cannot be recovered." >&2
        echo "  Consider: git init && git add -A && git commit -m 'Initial commit'" >&2
        echo "" >&2
        return
    fi

    local remotes
    remotes=$(git -C "$WORKSPACE_DIR" remote 2>/dev/null)
    if [[ -z "$remotes" ]]; then
        echo "Warning: Git repository has no remotes configured." >&2
        echo "  Without a remote, your work has no off-machine backup." >&2
        echo "  Consider: git remote add origin <url> && git push -u origin main" >&2
        echo "" >&2
    fi
}

setup_proxy() {
    if ! podman network exists "$INTERNAL_NETWORK" 2>/dev/null; then
        echo "Creating $INTERNAL_NETWORK network..."
        podman network create --internal "$INTERNAL_NETWORK"
    fi

    SESSION_ID=$(date +%s)-$$
    PROXY_NAME="paude-proxy-$SESSION_ID"

    cleanup() {
        podman kill "$PROXY_NAME" >/dev/null 2>&1 || true
    }
    trap cleanup EXIT INT TERM

    podman run -d --rm --name "$PROXY_NAME" \
        --network "$INTERNAL_NETWORK,podman" \
        "$PROXY_IMAGE" >/dev/null

    sleep 1
}

run_claude() {
    local network_args=()
    local proxy_env=()

    if [[ "$ALLOW_NETWORK" == "true" ]]; then
        echo "Warning: Network access enabled. Data exfiltration is possible." >&2
    else
        network_args=(--network "$INTERNAL_NETWORK")
        proxy_env=(
            -e "HTTPS_PROXY=http://$PROXY_NAME:3128"
            -e "HTTP_PROXY=http://$PROXY_NAME:3128"
            -e "https_proxy=http://$PROXY_NAME:3128"
            -e "http_proxy=http://$PROXY_NAME:3128"
        )
    fi

    podman run --rm -it \
        -w "$WORKSPACE_DIR" \
        "${network_args[@]}" \
        "${proxy_env[@]}" \
        "${ENV_ARGS[@]}" \
        "${MOUNT_ARGS[@]}" \
        "$IMAGE_NAME" \
        "${CLAUDE_ARGS[@]}"
}

# Main execution
check_requirements
build_images
setup_environment
setup_mounts
check_macos_volumes
check_git_safety

if [[ "$ALLOW_NETWORK" == "false" ]]; then
    setup_proxy
fi

run_claude
