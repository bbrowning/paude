#!/bin/bash
set -e

# Version and registry configuration
PAUDE_VERSION="0.2.0"
PAUDE_REGISTRY="${PAUDE_REGISTRY:-docker.io/bbrowning}"

INTERNAL_NETWORK="paude-internal"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Dev mode: set PAUDE_DEV=1 to build images locally instead of pulling from registry
if [[ "${PAUDE_DEV:-0}" == "1" ]]; then
    DEV_MODE=true
    IMAGE_NAME="paude:latest"
    PROXY_IMAGE="paude-proxy:latest"
else
    DEV_MODE=false
    IMAGE_NAME="$PAUDE_REGISTRY/paude:$PAUDE_VERSION"
    PROXY_IMAGE="$PAUDE_REGISTRY/paude-proxy:$PAUDE_VERSION"
fi

show_help() {
    cat <<'EOF'
paude - Run Claude Code in a secure Podman container

USAGE:
    paude [OPTIONS] [-- CLAUDE_ARGS...]

OPTIONS:
    -h, --help          Show this help message and exit
    -V, --version       Show paude version and exit
    --yolo              Enable YOLO mode (skip all permission prompts)
                        Claude can edit files and run commands without confirmation
    --allow-network     Allow unrestricted network access
                        By default, network is restricted to Vertex AI endpoints only

CLAUDE OPTIONS:
    All arguments after -- are passed directly to claude.
    Run 'paude -- --help' to see claude's options.

EXAMPLES:
    paude                           Start interactive claude session
    paude --yolo                    Start with YOLO mode (no permission prompts)
    paude -- -p "What is 2+2?"      Run claude with a prompt
    paude --yolo -- -p "Fix bugs"   YOLO mode with a prompt
    paude -- --help                 Show claude's help

SECURITY:
    By default, paude runs with network restricted to Google/Anthropic APIs only.
    Use --allow-network to permit all network access (enables data exfiltration).
    Combining --yolo with --allow-network is maximum risk mode.

EOF
}

show_version() {
    echo "paude $PAUDE_VERSION"
    if [[ "$DEV_MODE" == "true" ]]; then
        echo "  mode: development (PAUDE_DEV=1, building locally)"
    else
        echo "  mode: installed (pulling from $PAUDE_REGISTRY)"
    fi
}

# Parse paude-specific flags before -- separator
ALLOW_NETWORK=false
YOLO_MODE=false
CLAUDE_ARGS=()
PARSING_PAUDE_ARGS=true

for arg in "$@"; do
    if [[ "$PARSING_PAUDE_ARGS" == "true" ]]; then
        case "$arg" in
            --)
                PARSING_PAUDE_ARGS=false
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            -V|--version)
                show_version
                exit 0
                ;;
            --allow-network)
                ALLOW_NETWORK=true
                ;;
            --yolo)
                YOLO_MODE=true
                ;;
            *)
                # Unknown paude option - could be claude arg without --
                # For backwards compatibility, pass through to claude
                CLAUDE_ARGS+=("$arg")
                ;;
        esac
    else
        CLAUDE_ARGS+=("$arg")
    fi
done

resolve_path() {
    local path="$1"
    if [[ -e "$path" ]]; then
        cd -P "$(dirname "$path")" 2>/dev/null && echo "$(pwd -P)/$(basename "$path")"
    fi
}

show_macos_volume_help() {
    local volume_path
    volume_path=$(echo "$WORKSPACE_DIR" | cut -d'/' -f1-3)

    echo "" >&2
    echo "Podman on macOS only mounts /Users by default." >&2
    echo "To use paths under $volume_path, recreate your Podman machine with:" >&2
    echo "" >&2
    echo "  podman machine stop" >&2
    echo "  podman machine rm" >&2
    echo "  podman machine init \\" >&2
    echo "    --volume /Users:/Users \\" >&2
    echo "    --volume /private:/private \\" >&2
    echo "    --volume /var/folders:/var/folders \\" >&2
    echo "    --volume $volume_path:$volume_path" >&2
    echo "  podman machine start" >&2
    echo "" >&2
    echo "Note: This will remove your existing Podman machine. Container images" >&2
    echo "will need to be rebuilt/pulled after recreating the machine." >&2
}

check_requirements() {
    if ! command -v podman &> /dev/null; then
        echo "Error: podman is not installed or not in PATH" >&2
        echo "Please install podman: https://podman.io/getting-started/installation" >&2
        exit 1
    fi
}

ensure_images() {
    if [[ "$DEV_MODE" == "true" ]]; then
        # Dev mode: build locally if not present
        if ! podman image exists "$IMAGE_NAME" 2>/dev/null; then
            echo "Building $IMAGE_NAME image..."
            if ! podman build -t "$IMAGE_NAME" "$SCRIPT_DIR/containers/paude"; then
                echo "Error: Failed to build $IMAGE_NAME" >&2
                exit 1
            fi
        fi

        if [[ "$ALLOW_NETWORK" == "false" ]]; then
            if ! podman image exists "$PROXY_IMAGE" 2>/dev/null; then
                echo "Building $PROXY_IMAGE image..."
                if ! podman build -t "$PROXY_IMAGE" "$SCRIPT_DIR/containers/proxy"; then
                    echo "Error: Failed to build $PROXY_IMAGE" >&2
                    exit 1
                fi
            fi
        fi
    else
        # Installed mode: pull from registry if not present
        if ! podman image exists "$IMAGE_NAME" 2>/dev/null; then
            echo "Pulling $IMAGE_NAME..."
            if ! podman pull "$IMAGE_NAME"; then
                echo "Error: Failed to pull $IMAGE_NAME" >&2
                echo "Check your network connection or run 'podman login' if authentication is required." >&2
                exit 1
            fi
        fi

        if [[ "$ALLOW_NETWORK" == "false" ]]; then
            if ! podman image exists "$PROXY_IMAGE" 2>/dev/null; then
                echo "Pulling $PROXY_IMAGE..."
                if ! podman pull "$PROXY_IMAGE"; then
                    echo "Error: Failed to pull $PROXY_IMAGE" >&2
                    echo "Check your network connection or run 'podman login' if authentication is required." >&2
                    exit 1
                fi
            fi
        fi
    fi
}

setup_environment() {
    ENV_ARGS=()
    for var in CLAUDE_CODE_USE_VERTEX ANTHROPIC_VERTEX_PROJECT_ID GOOGLE_CLOUD_PROJECT; do
        if [[ -n "${!var}" ]]; then
            ENV_ARGS+=(-e "$var=${!var}")
        fi
    done

    for var in $(compgen -v | grep '^CLOUDSDK_AUTH'); do
        ENV_ARGS+=(-e "$var=${!var}")
    done
}

setup_mounts() {
    WORKSPACE_DIR="$(pwd -P)"

    MOUNT_ARGS=(
        -v "$WORKSPACE_DIR:$WORKSPACE_DIR:rw"
    )

    GCLOUD_DIR="$(resolve_path "$HOME/.config/gcloud")"
    if [[ -n "$GCLOUD_DIR" && -d "$GCLOUD_DIR" ]]; then
        MOUNT_ARGS+=(-v "$GCLOUD_DIR:/home/paude/.config/gcloud:ro")
    fi

    if [[ -d "$HOME/.claude" ]]; then
        CLAUDE_DIR="$(resolve_path "$HOME/.claude")"
        if [[ -n "$CLAUDE_DIR" && -d "$CLAUDE_DIR" ]]; then
            MOUNT_ARGS+=(-v "$CLAUDE_DIR:/tmp/claude.seed:ro")
            # Mount plugins at original host path for hardcoded plugin references
            if [[ -d "$CLAUDE_DIR/plugins" ]]; then
                MOUNT_ARGS+=(-v "$CLAUDE_DIR/plugins:$CLAUDE_DIR/plugins:ro")
            fi
        fi
    fi

    GITCONFIG="$(resolve_path "$HOME/.gitconfig")"
    if [[ -n "$GITCONFIG" && -f "$GITCONFIG" ]]; then
        MOUNT_ARGS+=(-v "$GITCONFIG:/home/paude/.gitconfig:ro")
    fi

    if [[ -f "$HOME/.claude.json" ]]; then
        CLAUDE_JSON="$(resolve_path "$HOME/.claude.json")"
        if [[ -n "$CLAUDE_JSON" && -f "$CLAUDE_JSON" ]]; then
            MOUNT_ARGS+=(-v "$CLAUDE_JSON:/tmp/claude.json.seed:ro")
        fi
    fi
}

check_macos_volumes() {
    if [[ "$(uname)" == "Darwin" && ! "$WORKSPACE_DIR" =~ ^/Users/ ]]; then
        test_output=$(podman run --rm \
            -v "$WORKSPACE_DIR:$WORKSPACE_DIR:rw" \
            "$IMAGE_NAME" \
            --version 2>&1) || {
            echo "$test_output" >&2
            show_macos_volume_help
            exit 1
        }
    fi
}

check_git_safety() {
    if [[ ! -d "$WORKSPACE_DIR/.git" ]]; then
        echo "Warning: No git repository in workspace." >&2
        echo "  Without git, deleted/modified files cannot be recovered." >&2
        echo "  Consider: git init && git add -A && git commit -m 'Initial commit'" >&2
        echo "" >&2
        return
    fi

    local remotes
    remotes=$(git -C "$WORKSPACE_DIR" remote 2>/dev/null)
    if [[ -z "$remotes" ]]; then
        echo "Warning: Git repository has no remotes configured." >&2
        echo "  Without a remote, your work has no off-machine backup." >&2
        echo "  Consider: git remote add origin <url> && git push -u origin main" >&2
        echo "" >&2
    fi
}

setup_proxy() {
    if ! podman network exists "$INTERNAL_NETWORK" 2>/dev/null; then
        echo "Creating $INTERNAL_NETWORK network..."
        podman network create --internal "$INTERNAL_NETWORK"
    fi

    SESSION_ID=$(date +%s)-$$
    PROXY_NAME="paude-proxy-$SESSION_ID"

    cleanup() {
        podman kill "$PROXY_NAME" >/dev/null 2>&1 || true
    }
    trap cleanup EXIT INT TERM

    # Get DNS from podman machine (works on macOS where containers run in a VM)
    local dns_env=()
    if podman machine inspect &>/dev/null; then
        local vm_dns
        vm_dns=$(podman machine ssh grep nameserver /etc/resolv.conf 2>/dev/null | awk '{print $2}' | head -1)
        if [[ -n "$vm_dns" ]]; then
            dns_env=(-e "SQUID_DNS=$vm_dns")
        fi
    fi

    podman run -d --rm --name "$PROXY_NAME" \
        --network "$INTERNAL_NETWORK,podman" \
        "${dns_env[@]}" \
        "$PROXY_IMAGE" >/dev/null

    sleep 1
}

run_claude() {
    local network_args=()
    local proxy_env=()

    if [[ "$YOLO_MODE" == "true" && "$ALLOW_NETWORK" == "true" ]]; then
        echo "" >&2
        echo "╔══════════════════════════════════════════════════════════════════╗" >&2
        echo "║  WARNING: MAXIMUM RISK MODE                                      ║" >&2
        echo "║                                                                  ║" >&2
        echo "║  --yolo + --allow-network = Claude can exfiltrate any file      ║" >&2
        echo "║  to the internet without confirmation. Only use if you trust    ║" >&2
        echo "║  the task completely.                                           ║" >&2
        echo "╚══════════════════════════════════════════════════════════════════╝" >&2
        echo "" >&2
        CLAUDE_ARGS=("--dangerously-skip-permissions" "${CLAUDE_ARGS[@]}")
    elif [[ "$YOLO_MODE" == "true" ]]; then
        echo "Warning: YOLO mode enabled. Claude can edit files and run commands without confirmation." >&2
        CLAUDE_ARGS=("--dangerously-skip-permissions" "${CLAUDE_ARGS[@]}")
    elif [[ "$ALLOW_NETWORK" == "true" ]]; then
        echo "Warning: Network access enabled. Data exfiltration is possible." >&2
    fi

    if [[ "$ALLOW_NETWORK" == "true" ]]; then
        :  # No proxy setup needed
    else
        network_args=(--network "$INTERNAL_NETWORK")
        proxy_env=(
            -e "HTTPS_PROXY=http://$PROXY_NAME:3128"
            -e "HTTP_PROXY=http://$PROXY_NAME:3128"
            -e "https_proxy=http://$PROXY_NAME:3128"
            -e "http_proxy=http://$PROXY_NAME:3128"
        )
    fi

    podman run --rm -it \
        -w "$WORKSPACE_DIR" \
        "${network_args[@]}" \
        "${proxy_env[@]}" \
        "${ENV_ARGS[@]}" \
        "${MOUNT_ARGS[@]}" \
        "$IMAGE_NAME" \
        "${CLAUDE_ARGS[@]}"
}

# Main execution
check_requirements
ensure_images
setup_environment
setup_mounts
check_macos_volumes
check_git_safety

if [[ "$ALLOW_NETWORK" == "false" ]]; then
    setup_proxy
fi

run_claude
